{% extends "base.html" %}

{% block title %}{{ product.name }} - Ethera Jewelry{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>{{ product.name }}</h1>
        <p class="meta">
            SKU: {{ product.sku }} • 
            {% if product.collection_name %}Collection: {{ product.collection_name }} • {% endif %}
            {% if product.product_type %}
                Type: {% if product.product_type == 'RING' %}Ring
                {% elif product.product_type == 'NECKLACE' %}Necklace
                {% elif product.product_type == 'EARRING' %}Earring
                {% elif product.product_type == 'BRACELET' %}Bracelet
                {% else %}{{ product.product_type }}{% endif %} • 
            {% endif %}
            Count: {{ product.count or 1 }} • Created {{ product.created_at.strftime('%Y-%m-%d') }}
        </p>
    </div>
    <div class="page-header-actions" style="display: flex; gap: 12px;">
        <a href="/products/{{ product.id }}/edit" class="btn btn-secondary">Edit</a>
        <form method="POST" action="/products/{{ product.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this product? This will also delete all BOM lines.');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
        <a href="/products" class="btn btn-secondary">Back</a>
    </div>
</div>

{% if product.description %}
<div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #e5e5e5;">
    <p>{{ product.description }}</p>
</div>
{% endif %}

<!-- Product Images Section -->
<div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #e5e5e5;">
    <h2 style="margin-bottom: 16px;">Product Images</h2>
    
    {% if product_images %}
    <!-- Image Carousel -->
    <div style="position: relative; max-width: 500px; margin: 0 auto 24px;">
        <div id="image-carousel" style="position: relative; width: 100%; background: #fafafa; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden;">
            <!-- Main Image Display -->
            <div style="position: relative; width: 100%; padding-top: 75%; background: #f5f5f5;">
                {% for image in product_images %}
                <img 
                    id="carousel-image-{{ loop.index0 }}" 
                    src="{{ image.image_url }}" 
                    alt="Product Image {{ loop.index }}" 
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; display: {% if loop.index0 == 0 %}block{% else %}none{% endif %};"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; flex-direction: column; color: #999;">
                    <p>Image not available</p>
                    <a href="{{ image.image_url }}" target="_blank" class="link">View URL</a>
                </div>
                {% endfor %}
            </div>
            
            <!-- Navigation Buttons -->
            {% if product_images|length > 1 %}
            <button 
                id="prev-btn" 
                onclick="changeImage(-1)" 
                style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                onmouseover="this.style.background='rgba(0,0,0,0.8)'"
                onmouseout="this.style.background='rgba(0,0,0,0.6)'"
                title="Previous image">
                ‹
            </button>
            <button 
                id="next-btn" 
                onclick="changeImage(1)" 
                style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                onmouseover="this.style.background='rgba(0,0,0,0.8)'"
                onmouseout="this.style.background='rgba(0,0,0,0.6)'"
                title="Next image">
                ›
            </button>
            
            <!-- Image Counter -->
            <div style="position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">
                <span id="image-counter">1</span> / <span id="image-total">{{ product_images|length }}</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Thumbnail Strip -->
        {% if product_images|length > 1 %}
        <div style="display: flex; gap: 8px; margin-top: 16px; overflow-x: auto; padding: 8px 0;">
            {% for image in product_images %}
            <img 
                src="{{ image.image_url }}" 
                alt="Thumbnail {{ loop.index }}"
                onclick="showImage({{ loop.index0 }})"
                id="thumb-{{ loop.index0 }}"
                style="width: 80px; height: 80px; object-fit: cover; border: 2px solid {% if loop.index0 == 0 %}#007bff{% else %}#e5e5e5{% endif %}; border-radius: 4px; cursor: pointer; flex-shrink: 0; transition: border-color 0.2s;"
                onmouseover="this.style.borderColor='#007bff'"
                onmouseout="if({{ loop.index0 }} !== currentImageIndex) this.style.borderColor='#e5e5e5'">
            {% endfor %}
        </div>
        {% endif %}
        
    </div>
    {% else %}
    <p class="meta" style="margin-bottom: 16px;">No images added yet.</p>
    {% endif %}
</div>

<h2>Bill of Materials</h2>
<form method="POST" action="/products/{{ product.id }}/bom" style="padding: 20px; border: 1px solid #e5e5e5; border-radius: 4px; margin-bottom: 24px; background-color: #fafafa;">
    <div class="bom-form-grid" style="display: grid; grid-template-columns: 2fr 2fr 1fr 2fr auto; gap: 12px; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="material_id" style="font-size: 13px;">Material</label>
            <select name="material_id" id="material_id" required onchange="loadPurchases()">
                <option value="">Select material...</option>
                {% for material in materials %}
                <option value="{{ material.id }}" data-unit="{{ material.unit }}">{{ material.name }} ({{ material.unit }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="purchase_id" style="font-size: 13px;">Purchase *</label>
            <select name="purchase_id" id="purchase_id" required disabled>
                <option value="">Select material first...</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="qty_required" style="font-size: 13px;">Quantity</label>
            <input type="number" name="qty_required" id="qty_required" step="0.01" required>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="note" style="font-size: 13px;">Note</label>
            <input type="text" name="note" id="note" placeholder="e.g. center stone">
        </div>
        <div>
            <button type="submit" class="btn" style="margin-top: 20px;">Add</button>
        </div>
    </div>
    <input type="hidden" name="unit" id="unit">
</form>

{% if bom_lines %}
<table>
    <thead>
        <tr>
            <th>Material</th>
            <th>Purchase</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Note</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for bom in bom_lines %}
        <tr>
            <td><strong>{{ bom.material_name }}</strong></td>
            <td class="meta">{{ bom.purchase_info }}</td>
            <td>{{ bom.qty_required }}</td>
            <td class="meta">{{ bom.unit }}</td>
            <td class="meta">{{ bom.note or '' }}</td>
            <td>
                <button onclick="deleteBOM('{{ bom.id }}', this)" class="btn btn-danger" style="padding: 4px 12px; font-size: 13px;">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <p>No BOM lines yet. Add materials above.</p>
</div>
{% endif %}

<h2 style="margin-top: 48px; padding-top: 32px; border-top: 1px solid #e5e5e5;">Estimated Cost</h2>
<div id="cost-estimate" style="margin-top: 24px;">
    <p class="meta">Loading cost estimate...</p>
</div>

<script>
// Image Carousel Functionality
let currentImageIndex = 0;
const totalImages = {{ product_images|length if product_images else 0 }};
const productImages = [
    {% if product_images %}
    {% for image in product_images %}
    { id: '{{ image.id }}', url: '{{ image.image_url }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
];

function showImage(index) {
    if (index < 0 || index >= totalImages || totalImages === 0) return;
    
    // Hide all images
    for (let i = 0; i < totalImages; i++) {
        const img = document.getElementById(`carousel-image-${i}`);
        const thumb = document.getElementById(`thumb-${i}`);
        if (img) img.style.display = 'none';
        if (thumb) {
            thumb.style.borderColor = i === index ? '#007bff' : '#e5e5e5';
        }
    }
    
    // Show selected image
    const selectedImg = document.getElementById(`carousel-image-${index}`);
    if (selectedImg) selectedImg.style.display = 'block';
    
    // Update counter
    const counter = document.getElementById('image-counter');
    if (counter) counter.textContent = index + 1;
    
    currentImageIndex = index;
    
    // Update navigation buttons visibility
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    if (prevBtn) prevBtn.style.display = index === 0 ? 'none' : 'flex';
    if (nextBtn) nextBtn.style.display = index === totalImages - 1 ? 'none' : 'flex';
}

function changeImage(direction) {
    const newIndex = currentImageIndex + direction;
    if (newIndex >= 0 && newIndex < totalImages) {
        showImage(newIndex);
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (totalImages > 1) {
        if (e.key === 'ArrowLeft') {
            changeImage(-1);
        } else if (e.key === 'ArrowRight') {
            changeImage(1);
        }
    }
});

// Initialize carousel
if (totalImages > 0) {
    showImage(0);
}

async function loadPurchases() {
    const materialSelect = document.getElementById('material_id');
    const materialId = materialSelect.value;
    const purchaseSelect = document.getElementById('purchase_id');
    const unitInput = document.getElementById('unit');
    
    if (!materialId) {
        purchaseSelect.innerHTML = '<option value="">Select material first...</option>';
        purchaseSelect.disabled = true;
        unitInput.value = '';
        return;
    }
    
    // Get unit from selected material
    const selectedOption = materialSelect.options[materialSelect.selectedIndex];
    const unit = selectedOption.getAttribute('data-unit');
    unitInput.value = unit || '';
    
    try {
        const response = await fetch(`/api/materials/${materialId}/purchases`);
        const purchases = await response.json();
        
        if (purchases.length === 0) {
            purchaseSelect.innerHTML = '<option value="">No purchases found for this material</option>';
            purchaseSelect.disabled = true;
            return;
        }
        
        purchaseSelect.innerHTML = '<option value="">Select purchase...</option>';
        purchases.forEach(purchase => {
            const option = document.createElement('option');
            option.value = purchase.id;
            const date = new Date(purchase.purchase_date).toLocaleDateString();
            option.textContent = `${purchase.supplier_name} - ${purchase.unit_cost} ${purchase.currency} (${date})`;
            purchaseSelect.appendChild(option);
        });
        purchaseSelect.disabled = false;
    } catch (error) {
        purchaseSelect.innerHTML = '<option value="">Error loading purchases</option>';
        purchaseSelect.disabled = true;
    }
}

async function loadCostEstimate() {
    try {
        const response = await fetch('/api/products/{{ product.id }}/cost-estimate');
        const data = await response.json();
        
        let html = '';
        
        if (data.has_missing_costs) {
            html += '<div class="alert alert-warning">Some materials are missing cost data. Please add purchase records.</div>';
        }
        
        if (data.material_breakdown && data.material_breakdown.length > 0) {
            html += '<table>';
            html += '<thead><tr><th>Material</th><th>Quantity</th><th>Unit Cost</th><th>Total Cost</th><th>Total Cost (TRY)</th><th></th></tr></thead>';
            html += '<tbody>';
            
            for (const item of data.material_breakdown) {
                html += '<tr>';
                html += '<td><strong>' + item.material_name + '</strong></td>';
                html += '<td>' + item.qty_required + ' <span class="meta">' + item.unit + '</span></td>';
                if (item.has_cost) {
                    html += '<td>' + item.unit_cost + ' <span class="meta">' + item.currency + '</span></td>';
                    html += '<td><strong>' + item.total_cost.toFixed(2) + '</strong> <span class="meta">' + item.currency + '</span></td>';
                    if (item.total_cost_try !== null && item.total_cost_try !== undefined) {
                        html += '<td><strong>' + item.total_cost_try.toFixed(2) + '</strong> <span class="meta">TRY</span></td>';
                    } else {
                        html += '<td class="meta">-</td>';
                    }
                    html += '<td><span class="badge">✓</span></td>';
                } else {
                    html += '<td class="meta">-</td>';
                    html += '<td class="meta">-</td>';
                    html += '<td class="meta">-</td>';
                    html += '<td><span class="badge" style="background-color: #fff5f5; color: #d32f2f;">Missing</span></td>';
                }
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            
            // Display currency totals
            if (data.currency_totals && data.currency_totals.length > 0) {
                html += '<div style="margin-top: 24px; padding: 20px; background-color: #fafafa; border: 1px solid #e5e5e5; border-radius: 4px;">';
                html += '<div style="font-size: 18px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;">Total Cost by Currency:</div>';
                data.currency_totals.forEach(currencyTotal => {
                    html += '<div style="font-size: 20px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">';
                    html += currencyTotal.total.toFixed(2) + ' <span style="font-size: 16px; font-weight: 400; color: #666;">' + currencyTotal.currency + '</span>';
                    html += '</div>';
                });
                
                // Show Turkish Lira total if available
                if (data.total_try !== null && data.total_try !== undefined) {
                    html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e5e5;">';
                    html += '<div style="font-size: 16px; font-weight: 500; color: #666; margin-bottom: 8px;">Total in Turkish Lira:</div>';
                    html += '<div style="font-size: 24px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px;">';
                    html += data.total_try.toFixed(2) + ' <span style="font-size: 18px; font-weight: 400; color: #666;">TRY</span>';
                    html += '</div>';
                    
                    // Show exchange rates used
                    if (data.exchange_rates && data.exchange_rates.length > 0) {
                        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e5;">';
                        html += '<div style="font-size: 13px; font-weight: 500; color: #666; margin-bottom: 8px;">Exchange Rates Used (based on purchase dates):</div>';
                        data.exchange_rates.forEach(rateInfo => {
                            html += '<div style="font-size: 13px; color: #666; margin-bottom: 4px;">';
                            html += '1 ' + rateInfo.from_currency + ' = ' + rateInfo.rate.toFixed(4) + ' ' + rateInfo.to_currency;
                            if (!rateInfo.is_from_api) {
                                html += ' <span style="color: #d32f2f; font-size: 11px;">(fallback - API unavailable)</span>';
                            } else {
                                html += ' <span style="color: #27ae60; font-size: 11px;">(from API)</span>';
                            }
                            html += '</div>';
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
        } else {
            html += '<p class="meta">No BOM lines to calculate cost for.</p>';
        }
        
        document.getElementById('cost-estimate').innerHTML = html;
    } catch (error) {
        document.getElementById('cost-estimate').innerHTML = '<p style="color: #d32f2f;">Error loading cost estimate: ' + error.message + '</p>';
    }
}

async function deleteBOM(bomId, buttonElement) {
    if (!confirm('Are you sure you want to delete this BOM line?')) {
        return;
    }
    
    // Show loading state on the button that was clicked
    if (buttonElement && window.showButtonLoading) {
        window.showButtonLoading(buttonElement);
    } else if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.textContent = 'Processing...';
    }
    
    try {
        const response = await fetch('/api/products/bom/' + bomId, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            if (buttonElement && window.hideButtonLoading) {
                window.hideButtonLoading(buttonElement);
            } else if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.textContent = 'Delete';
            }
            alert('Error deleting BOM line');
        }
    } catch (error) {
        if (buttonElement && window.hideButtonLoading) {
            window.hideButtonLoading(buttonElement);
        } else if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.textContent = 'Delete';
        }
        alert('Error deleting BOM line: ' + error.message);
    }
}

loadCostEstimate();
</script>
{% endblock %}
