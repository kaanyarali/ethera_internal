{% extends "base.html" %}

{% block title %}Products - Ethera Jewelry{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Products</h1>
        <p class="meta">Manage your jewelry products</p>
    </div>
    <div style="display: flex; gap: 12px; align-items: center;">
        <button type="button" id="save-counts-btn" class="btn" style="display: none;">Save Changes</button>
        <a href="/products/export/excel" class="btn btn-secondary">Export to Excel</a>
        <a href="/products/new" class="btn">Add Product</a>
        {% if products %}
        <form method="POST" action="/products/delete-all" style="display: inline;" onsubmit="return confirmDeleteAll(event);">
            <button type="submit" class="btn btn-danger">Delete All</button>
        </form>
        {% endif %}
    </div>
</div>

{% if products %}
<table>
    <thead>
        <tr>
            <th>SKU</th>
            <th>Name</th>
            <th>Collection</th>
            <th>Type</th>
            <th>Description</th>
            <th>Count</th>
            <th>Created</th>
            <th style="text-align: right;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for product in products %}
        <tr>
            <td class="meta">{{ product.sku }}</td>
            <td><a href="/products/{{ product.id }}" class="link"><strong>{{ product.name }}</strong></a></td>
            <td class="meta">{{ product.collection_name or '-' }}</td>
            <td class="meta">
                {% if product.product_type %}
                    {% if product.product_type == 'RING' %}Ring
                    {% elif product.product_type == 'NECKLACE' %}Necklace
                    {% elif product.product_type == 'EARRING' %}Earring
                    {% elif product.product_type == 'BRACELET' %}Bracelet
                    {% else %}{{ product.product_type }}{% endif %}
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="meta">{{ product.description or '' }}</td>
            <td>
                <input type="number" 
                       data-product-id="{{ product.id }}" 
                       data-original-count="{{ product.count or 1 }}"
                       value="{{ product.count or 1 }}" 
                       min="1" 
                       class="count-input editable-count" 
                       required>
            </td>
            <td class="meta">{{ product.created_at.strftime('%Y-%m-%d') }}</td>
            <td style="text-align: right;">
                <a href="/products/{{ product.id }}/edit" class="link">Edit</a>
                <span style="margin: 0 8px; color: #e5e5e5;">|</span>
                <form method="POST" action="/products/{{ product.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this product? This will also delete all BOM lines.');">
                    <button type="submit" class="btn btn-danger" style="padding: 4px 12px; font-size: 13px;">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if total_pages > 1 %}
<div class="pagination">
    {% if has_prev %}
    <a href="/products?page={{ page - 1 }}&per_page={{ per_page }}" class="pagination-btn">‹ Previous</a>
    {% else %}
    <span class="pagination-btn disabled">‹ Previous</span>
    {% endif %}
    
    {% for p in page_numbers %}
        {% if p is none %}
        <span class="pagination-btn" style="border: none; cursor: default; background: transparent;">...</span>
        {% elif p == page %}
        <span class="pagination-btn active">{{ p }}</span>
        {% else %}
        <a href="/products?page={{ p }}&per_page={{ per_page }}" class="pagination-btn">{{ p }}</a>
        {% endif %}
    {% endfor %}
    
    {% if has_next %}
    <a href="/products?page={{ page + 1 }}&per_page={{ per_page }}" class="pagination-btn">Next ›</a>
    {% else %}
    <span class="pagination-btn disabled">Next ›</span>
    {% endif %}
    
    <span class="pagination-info">Showing {{ (page - 1) * per_page + 1 }}-{% if page * per_page > total_count %}{{ total_count }}{% else %}{{ page * per_page }}{% endif %} of {{ total_count }}</span>
</div>
{% elif total_count > 0 %}
<div class="pagination">
    <span class="pagination-info">Showing all {{ total_count }} items</span>
</div>
{% endif %}
{% else %}
<div class="empty-state">
    <p>No products found.</p>
    <p style="margin-top: 16px;"><a href="/products/new" class="link">Add your first product</a></p>
</div>
{% endif %}

<script>
function confirmDeleteAll(event) {
    event.preventDefault();
    const productCount = {{ products|length }};
    
    // Double confirmation with typed confirmation
    const message = `⚠️ WARNING: This will permanently delete ALL ${productCount} product(s) and all associated data (BOM lines, images).\n\nThis action CANNOT be undone!\n\nType "DELETE ALL" to confirm:`;
    const userInput = prompt(message);
    
    if (userInput === "DELETE ALL") {
        // Show loading state on the button
        const form = event.target.closest('form');
        const button = form.querySelector('button[type="submit"]');
        if (button && window.showButtonLoading) {
            window.showButtonLoading(button);
        } else if (button) {
            button.disabled = true;
            button.textContent = 'Deleting...';
        }
        
        // Submit the form
        form.submit();
        return true;
    } else {
        alert('Deletion cancelled. You must type "DELETE ALL" exactly to confirm.');
        return false;
    }
}

(function() {
    const saveBtn = document.getElementById('save-counts-btn');
    const countInputs = document.querySelectorAll('.editable-count');
    let hasChanges = false;
    
    // Track changes
    countInputs.forEach(input => {
        input.addEventListener('input', function() {
            const original = parseInt(this.dataset.originalCount) || 1;
            const current = parseInt(this.value) || 1;
            
            if (current !== original) {
                this.classList.add('count-changed');
                hasChanges = true;
                saveBtn.style.display = 'block';
            } else {
                this.classList.remove('count-changed');
                // Check if any other inputs have changes
                const anyChanged = Array.from(countInputs).some(inp => {
                    const orig = parseInt(inp.dataset.originalCount) || 1;
                    const curr = parseInt(inp.value) || 1;
                    return curr !== orig;
                });
                if (!anyChanged) {
                    hasChanges = false;
                    saveBtn.style.display = 'none';
                }
            }
        });
    });
    
    // Save all changes
    saveBtn.addEventListener('click', async function() {
        const updates = [];
        
        countInputs.forEach(input => {
            const original = parseInt(input.dataset.originalCount) || 1;
            const current = parseInt(input.value) || 1;
            
            if (current !== original) {
                updates.push({
                    product_id: input.dataset.productId,
                    count: current
                });
            }
        });
        
        if (updates.length === 0) {
            saveBtn.style.display = 'none';
            return;
        }
        
        // Show loading state
        if (window.showButtonLoading) {
            window.showButtonLoading(saveBtn);
        } else {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Processing...';
        }
        
        try {
            const response = await fetch('/api/products/bulk-update-counts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ updates: updates })
            });
            
            if (response.ok) {
                // Update original values
                countInputs.forEach(input => {
                    const current = parseInt(input.value) || 1;
                    input.dataset.originalCount = current;
                    input.classList.remove('count-changed');
                });
                
                saveBtn.style.display = 'none';
                // Reload page to show updated values
                window.location.reload();
            } else {
                const error = await response.json();
                if (window.hideButtonLoading) {
                    window.hideButtonLoading(saveBtn);
                } else {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save All Changes';
                }
                alert('Error updating counts: ' + (error.detail || 'Unknown error'));
            }
        } catch (error) {
            if (window.hideButtonLoading) {
                window.hideButtonLoading(saveBtn);
            } else {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save All Changes';
            }
            alert('Error updating counts: ' + error.message);
        }
    });
})();
</script>
{% endblock %}
