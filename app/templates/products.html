{% extends "base.html" %}

{% block title %}Products - Ethera Jewelry{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Products</h1>
        <p class="meta">Manage your jewelry products</p>
    </div>
    <div style="display: flex; gap: 12px; align-items: center;">
        <button type="button" id="save-counts-btn" class="btn" style="display: none;">Save Changes</button>
        <a href="/products/export/excel" class="btn btn-secondary">Export to Excel</a>
        <a href="/products/new" class="btn">Add Product</a>
    </div>
</div>

{% if products %}
<table>
    <thead>
        <tr>
            <th>SKU</th>
            <th>Name</th>
            <th>Description</th>
            <th>Count</th>
            <th>Created</th>
            <th style="text-align: right;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for product in products %}
        <tr>
            <td class="meta">{{ product.sku }}</td>
            <td><a href="/products/{{ product.id }}" class="link"><strong>{{ product.name }}</strong></a></td>
            <td class="meta">{{ product.description or '' }}</td>
            <td>
                <input type="number" 
                       data-product-id="{{ product.id }}" 
                       data-original-count="{{ product.count or 1 }}"
                       value="{{ product.count or 1 }}" 
                       min="1" 
                       class="count-input editable-count" 
                       required>
            </td>
            <td class="meta">{{ product.created_at.strftime('%Y-%m-%d') }}</td>
            <td style="text-align: right;">
                <a href="/products/{{ product.id }}/edit" class="link">Edit</a>
                <span style="margin: 0 8px; color: #e5e5e5;">|</span>
                <form method="POST" action="/products/{{ product.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this product? This will also delete all BOM lines.');">
                    <button type="submit" class="btn btn-danger" style="padding: 4px 12px; font-size: 13px;">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <p>No products found.</p>
    <p style="margin-top: 16px;"><a href="/products/new" class="link">Add your first product</a></p>
</div>
{% endif %}

<script>
(function() {
    const saveBtn = document.getElementById('save-counts-btn');
    const countInputs = document.querySelectorAll('.editable-count');
    let hasChanges = false;
    
    // Track changes
    countInputs.forEach(input => {
        input.addEventListener('input', function() {
            const original = parseInt(this.dataset.originalCount) || 1;
            const current = parseInt(this.value) || 1;
            
            if (current !== original) {
                this.classList.add('count-changed');
                hasChanges = true;
                saveBtn.style.display = 'block';
            } else {
                this.classList.remove('count-changed');
                // Check if any other inputs have changes
                const anyChanged = Array.from(countInputs).some(inp => {
                    const orig = parseInt(inp.dataset.originalCount) || 1;
                    const curr = parseInt(inp.value) || 1;
                    return curr !== orig;
                });
                if (!anyChanged) {
                    hasChanges = false;
                    saveBtn.style.display = 'none';
                }
            }
        });
    });
    
    // Save all changes
    saveBtn.addEventListener('click', async function() {
        const updates = [];
        
        countInputs.forEach(input => {
            const original = parseInt(input.dataset.originalCount) || 1;
            const current = parseInt(input.value) || 1;
            
            if (current !== original) {
                updates.push({
                    product_id: input.dataset.productId,
                    count: current
                });
            }
        });
        
        if (updates.length === 0) {
            saveBtn.style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch('/api/products/bulk-update-counts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ updates: updates })
            });
            
            if (response.ok) {
                // Update original values
                countInputs.forEach(input => {
                    const current = parseInt(input.value) || 1;
                    input.dataset.originalCount = current;
                    input.classList.remove('count-changed');
                });
                
                saveBtn.style.display = 'none';
                // Reload page to show updated values
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Error updating counts: ' + (error.detail || 'Unknown error'));
            }
        } catch (error) {
            alert('Error updating counts: ' + error.message);
        }
    });
})();
</script>
{% endblock %}
