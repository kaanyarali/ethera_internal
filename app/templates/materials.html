{% extends "base.html" %}

{% block title %}Materials - Ethera Jewelry{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Materials</h1>
        <p class="meta">Manage your inventory materials</p>
    </div>
    <div style="display: flex; gap: 12px; align-items: center;">
        <a href="/materials/new" class="btn">Add Material</a>
        {% if materials %}
        <form method="POST" action="/materials/delete-all" style="display: inline;" onsubmit="return confirmDeleteAll(event, 'materials');">
            <button type="submit" class="btn btn-danger">Delete All</button>
        </form>
        {% endif %}
    </div>
</div>

{% if materials %}
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Unit</th>
            <th>Notes</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for material in materials %}
        <tr>
            <td><strong>{{ material.name }}</strong></td>
            <td><span class="badge">
                {% if 'type' in material %}
                    {{ material['type'] if material['type'] else 'N/A' }}
                {% else %}
                    N/A
                {% endif %}
            </span></td>
            <td>{{ material.unit }}</td>
            <td class="meta">{{ material.notes or '' }}</td>
            <td>
                <a href="/materials/{{ material.id }}/edit" class="link">Edit</a>
                <span style="margin: 0 8px; color: #e5e5e5;">|</span>
                <form method="POST" action="/materials/{{ material.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this material?');">
                    <button type="submit" class="btn btn-danger" style="padding: 4px 12px; font-size: 13px;">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <p>No materials found.</p>
    <p style="margin-top: 16px;"><a href="/materials/new" class="link">Add your first material</a></p>
</div>
{% endif %}

<script>
function confirmDeleteAll(event, type) {
    event.preventDefault();
    const count = {{ materials|length }};
    const typeName = type === 'materials' ? 'material' : 'purchase';
    const typeNamePlural = type === 'materials' ? 'materials' : 'purchases';
    
    let message = `⚠️ WARNING: This will permanently delete ALL ${count} ${typeNamePlural}(s)`;
    if (type === 'materials') {
        message += ' and all associated data (BOM lines, purchases)';
    } else if (type === 'purchases') {
        message += ' (only those not referenced by BOM lines)';
    }
    message += `.\n\nThis action CANNOT be undone!\n\nType "DELETE ALL" to confirm:`;
    
    const userInput = prompt(message);
    
    if (userInput === "DELETE ALL") {
        // Show loading state on the button
        const form = event.target.closest('form');
        const button = form.querySelector('button[type="submit"]');
        if (button && window.showButtonLoading) {
            window.showButtonLoading(button);
        } else if (button) {
            button.disabled = true;
            button.textContent = 'Deleting...';
        }
        
        // Submit the form
        form.submit();
        return true;
    } else {
        alert('Deletion cancelled. You must type "DELETE ALL" exactly to confirm.');
        return false;
    }
}
</script>
{% endblock %}
